########################### 
#PURPOSE: R
#INPUT: 
#OUTPUT: 
#DEVELOPED: 
#CONTACT: LacherI@si.edu
#NOTES:
#IMPORTANT: 


############################

# SET WORKING DIRECTORY

# ----------------------------------------------
################################################

# PACKAGES NEEDED
# Rasters
library(raster)
library(rgdal) # For writing .tif files
# library(gdistance)

# SET TEMP DIRECTORY
rasterOptions(tmpdir = "Y:/Lacher/rtempCLEARME/")



# ----------------------------------------------
# FILE LOCATIONS: 
Output_Folder <- "Y:/Lacher/ProtectedLandsProject/PatchesTransitions_BR/Patch_Stats/"
BR_fileLoc<-"Y:/Lacher/IaraSpatialLayers_HF/PreparedRasters/ProLands/BlueRidge/"

# ----------------------------------------------
# READ INPUT FILES:

# Original Rasters

# Tables with stats
iStats_corepat<-read.csv("Y:/Lacher/ProtectedLandsProject/PatchesTransitions_BR/Patch_Stats/iStats_corepat.csv")

pat_dist_min<-read.table(paste0(Output_Folder,"pat_dist_min.txt"), sep=",", header=TRUE)

pat_distm4<-read.table(paste0(Output_Folder,"pat_distm4.txt"), sep=",", header=TRUE)

############################################################################################
# ~~~ CODE BEGINS ~~~ #
############################################################################################
> str(pat_distm4)
# 'data.frame':	252930 obs. of  3 variables:
 # $ patchID  : int  1 1 1 1 1 1 1 1 1 1 ...
 # $ d_patchID: int  3765 4727 945 2904 945 4501 4501 3767 4727 2904 ...
 # $ near_dist: num  19521 20570 20020 18424 16521 ...
> str(pat_dist_min)
# 'data.frame':	3531 obs. of  4 variables:
 # $ patchID    : int  11 17 49 64 69 97 120 145 158 250 ...
 # $ min_dist_km: num  7.47 7.47 0.179 0.179 0.906 ...
 # $ d_patchID  : Factor w/ 2151 levels "1","10011","10086",..: 212 52 1499 1120 2117 1623 155 80 413 172 ...
 # $ numDP      : int  1 1 1 1 1 1 1 1 1 1 ...
> str(iStats_corepat)
# 'data.frame':	4155 obs. of  17 variables:
 # $ patchID          : int  1 11 17 49 64 69 97 120 145 158 ...
 # $ n.cell           : int  151 19 57 272 48 365 349 190 21 503 ...
 # $ n.core.cell      : int  61 1 15 8 4 109 96 3 2 75 ...
 # $ n.edges.perimeter: int  116 32 52 418 64 282 328 368 26 628 ...
 # $ n.edges.internal : int  488 44 176 670 128 1178 1068 392 58 1384 ...
 # $ area             : num  4892400 615600 1846800 8812800 1555200 ...
 # $ core.area        : int  1976400 32400 486000 259200 129600 3531600 3110400 97200 64800 2430000 ...
 # $ perimeter        : int  20880 5760 9360 75240 11520 50760 59040 66240 4680 113040 ...
 # $ perim.area.ratio : num  0.00427 0.00936 0.00507 0.00854 0.00741 ...
 # $ shape.index      : num  2.32 1.78 1.62 6.33 2.29 ...
 # $ frac.dim.index   : num  1.11 1.09 1.08 1.23 1.12 ...
 # $ core.area.index  : num  0.404 0.0526 0.2632 0.0294 0.0833 ...
 # $ Transition       : int  1800 1800 1800 1800 1800 1800 1800 1800 1800 1800 ...
 # $ Type             : Factor w/ 3 levels "Expanded","noMeas",..: 2 2 2 2 2 2 2 2 2 2 ...
 # $ estYr            : int  1800 1819 1819 1819 1819 1819 1819 1819 1819 1819 ...
 # $ area.ha          : num  489.2 61.6 184.7 881.3 155.5 ...
 # $ core.area.ha     : num  197.64 3.24 48.6 25.92 12.96 ...

# ----------------------------------------------
 # Join distance to patch stats:
 joinA <- full_join(iStats_corepat, pat_dist_min)
 
> str(joinA)
# 'data.frame':	4155 obs. of  20 variables:
 # $ patchID          : int  1 11 17 49 64 69 97 120 145 158 ...
 # $ n.cell           : int  151 19 57 272 48 365 349 190 21 503 ...
 # $ n.core.cell      : int  61 1 15 8 4 109 96 3 2 75 ...
 # $ n.edges.perimeter: int  116 32 52 418 64 282 328 368 26 628 ...
 # $ n.edges.internal : int  488 44 176 670 128 1178 1068 392 58 1384 ...
 # $ area             : num  4892400 615600 1846800 8812800 1555200 ...
 # $ core.area        : int  1976400 32400 486000 259200 129600 3531600 3110400 97200 64800 2430000 ...
 # $ perimeter        : int  20880 5760 9360 75240 11520 50760 59040 66240 4680 113040 ...
 # $ perim.area.ratio : num  0.00427 0.00936 0.00507 0.00854 0.00741 ...
 # $ shape.index      : num  2.32 1.78 1.62 6.33 2.29 ...
 # $ frac.dim.index   : num  1.11 1.09 1.08 1.23 1.12 ...
 # $ core.area.index  : num  0.404 0.0526 0.2632 0.0294 0.0833 ...
 # $ Transition       : int  1800 1800 1800 1800 1800 1800 1800 1800 1800 1800 ...
 # $ Type             : Factor w/ 3 levels "Expanded","noMeas",..: 2 2 2 2 2 2 2 2 2 2 ...
 # $ estYr            : int  1800 1819 1819 1819 1819 1819 1819 1819 1819 1819 ...
 # $ area.ha          : num  489.2 61.6 184.7 881.3 155.5 ...
 # $ core.area.ha     : num  197.64 3.24 48.6 25.92 12.96 ...
 # $ min_dist_km      : num  NA 7.47 7.47 0.179 0.179 ...
 # $ d_patchID        : Factor w/ 2151 levels "1","10011","10086",..: NA 212 52 1499 1120 2117 1623 155 80 413 ...
 # $ numDP            : int  NA 1 1 1 1 1 1 1 1 1 ...
 
 
 
 #ID the maximum number of unique numDPs:
# max(pat_dist_min$numDP) #OLD: 29, NEW: 32

# ----------------------------------------------
# remember, this excludes unknowns and patches with no core area

# TRY TO IDENTIFY AREAS WITH THE MOST FOCUS
# create table for moran's I analysis.
# (1) Need to filter by distance <= 500m 
# (2) Connect area of patch to table. Weight = inverse area
 


# reshape 

library(reshape)

test<-cast(pat_distm4, patchID~d_patchID, min)# ~ 9 minutes
npat <- test


# create new column with the number of times distance >= 500
npat$pat_ct500 <- apply(test,1,function(x) sum(x <=500)) 
npat$pat_ct1000 <- apply(test,1,function(x) sum(x <=1000)) 

# > summary(npat$pat_ct500)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  # 0.000   0.000   1.000   1.471   2.000  33.000       1 
# > summary(npat$pat_ct1000)
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  # 0.000   1.000   2.000   2.239   3.000  40.000       1

# Select the columns to join in each df
npat2 <- select(npat, patchID, pat_ct500, pat_ct1000)
joinA2 <- select(joinA, patchID, estYr, min_dist_km, d_patchID, area.ha)

# Join to test by patchID
moran <- full_join(joinA2, npat2)

# Create column for inverse area
moran$inv_area <- 1/moran$area.ha

# create weighted pat_cnt column
moran$wpat_ct500 <- moran$pat_ct500 * moran$inv_area
moran$wpat_ct1000 <- moran$pat_ct1000 * moran$inv_area

#save to it can be joined to polygon layer in ArcGIS 
# WRITE TO FILE
write.table(moran, file = "Y:/Lacher/ProtectedLandsProject/PatchesTransitions_BR/Patch_Stats/moran.txt", row.names=FALSE, sep=",")

# READ TO FILE
moran<-read.table("Y:/Lacher/ProtectedLandsProject/PatchesTransitions_BR/Patch_Stats/moran.txt", sep=",", header=TRUE)

# > str(moran) #NEW
# 'data.frame':	4121 obs. of  10 variables:
 # $ patchID    : int  1 11 17 49 64 69 97 120 145 158 ...
 # $ estYr      : int  1800 1819 1819 1819 1819 1819 1819 1819 1819 1819 ...
 # $ min_dist.km: num  NA 7.47 7.47 0.179 0.179 ...
 # $ d_patchID  : Factor w/ 2513 levels "1","10000","10015",..: NA 471 80 1846 1466 2477 1976 387 154 705 ...
 # $ area.ha    : num  489.2 61.6 184.7 881.3 155.5 ...
 # $ pat_ct500  : int  1 0 0 1 1 0 0 0 0 0 ...
 # $ pat_ct1000 : int  2 0 0 1 1 1 1 0 0 0 ...
 # $ inv_area   : num  0.00204 0.01624 0.00541 0.00113 0.00643 ...
 # $ wpat_ct500 : num  0.00204 0 0 0.00113 0.00643 ...
 # $ wpat_ct1000: num  0.00409 0 0 0.00113 0.00643 ...


# > str(moran) OLD: * I don't think I need the er_maj... 
# 'data.frame':	4152 obs. of  11 variables:
 # $ patchID    : int  1 15 20 62 70 77 101 129 150 186 ...
 # $ estYr      : int  1800 1819 1819 1819 1819 1819 1819 1819 1819 1819 ...
 # $ er_maj     : int  1 9 9 9 9 9 9 3 3 9 ...
 # $ min_dist.km: num  NA 7.55 7.55 0.18 0.18 ...
 # $ d_patchID  : Factor w/ 2529 levels "1","1003","10040",..: NA 565 421 1994 1777 13 2150 422 242 773 ...
 # $ area.ha    : num  460.1 48.6 181.4 878 129.6 ...
 # $ pat_ct500  : int  2 1 1 2 2 1 1 1 1 1 ...
 # $ pat_ct1000 : int  4 2 2 3 3 3 3 2 2 2 ...
 # $ inv_area   : num  0.00217 0.02058 0.00551 0.00114 0.00772 ...
 # $ wpat_ct500 : num  0.00435 0.02058 0.00551 0.00228 0.01543 ...
 # $ wpat_ct1000: num  0.00869 0.04115 0.01102 0.00342 0.02315 ...

 
 # ----------------------------------------------
 # NOW JOIN TO THE POLYGON LAYER.(sNCyrly_pidI) (ArcMap)
 # ----------------------------------------------
# And export table to patch Stats folder as "sNCyrly_pidIJoin_tab.txt"
 
# # testing ArcGIS moran on:
# - ncyrly_pid_p - didn't work. not projected??
# - ncyrly_pidPr - does work. different projection than most of the other stuff



 jointab<-read.table("Y:/Lacher/ProtectedLandsProject/PatchesTransitions_BR/Patch_Stats/sNCyrly_pidIJoin_tab.txt", sep=",", header=TRUE)

 
 # > str(jointab) #NEW:
# 'data.frame':	6826 obs. of  13 variables:
 # $ FID        : int  0 1 2 3 4 5 6 7 8 9 ...
 # $ ID         : int  1 2 3 4 5 6 7 8 9 10 ...
 # $ GRIDCODE   : int  10363 10363 4560 4559 7730 3900 4560 6595 4947 8391 ...
 # $ patchID    : int  10363 10363 4560 4559 7730 3900 4560 6595 4947 8391 ...
 # $ estYr      : int  9999 9999 2000 2000 2007 1997 2000 2005 2001 2008 ...
 # $ min_dist_km: num  0 0 0 1.79 2.14 ...
 # $ d_patchID  : Factor w/ 2513 levels "1","10000","10015",..: 455 455 1153 1153 1788 967 1153 1341 967 1474 ...
 # $ area_ha    : num  3628.8 3628.8 175 71.3 149 ...
 # $ pat_ct500  : int  1 1 1 1 1 1 1 1 2 1 ...
 # $ pat_ct1000 : int  2 2 1 1 1 1 1 2 2 4 ...
 # $ inv_area   : num  0.000276 0.000276 0.005716 0.014029 0.00671 ...
 # $ wpat_ct500 : num  0.000276 0.000276 0.005716 0.014029 0.00671 ...
 # $ wpat_ct1000: num  0.000551 0.000551 0.005716 0.014029 0.00671 ...

# > str(jointab) #OLD:
# 'data.frame':	6735 obs. of  14 variables:
 # $ FID       : int  0 1 2 3 4 5 6 7 8 9 ...
 # $ ID        : int  1 2 3 4 5 6 7 8 9 10 ...
 # $ GRIDCODE  : int  10452 3135 3964 8449 4614 6640 8449 4991 8448 7789 ...
 # $ patchID   : int  10452 3135 3964 8449 4614 6640 8449 4991 8448 7789 ...
 # $ estYr     : int  9999 1991 1997 2008 2000 2005 2008 2001 2008 2007 ...
 # $ er_maj    : int  9 9 9 9 9 9 9 9 9 9 ...
 # $ min_dist_k: num  0 NA 4.14 0 0 ...
 # $ d_patchID : Factor w/ 2529 levels "1","1003","10040",..: 487 NA 975 1475 1172 975 1475 975 2166 1788 ...
 # $ area_ha   : num  3628.8 48.6 68 71.3 165.2 ...
 # $ pat_ct500 : int  1 0 1 3 1 0 3 3 1 1 ...
 # $ pat_ct1000: int  4 1 2 5 2 1 5 4 2 3 ...
 # $ inv_area  : num  0.000276 0.020576 0.014697 0.014029 0.006052 ...
 # $ wpat_ct500: num  0.000276 0 0.014697 0.042088 0.006052 ...
 # $ wpat_ct100: num  0.0011 0.0206 0.0294 0.0701 0.0121 ...



# Filter out unknowns:
join_unk <-filter(jointab, estYr<=2015)


# > str(join_unk)
# 'data.frame':	5268 obs. of  13 variables:
 # $ FID        : int  2 3 4 5 6 7 8 9 10 11 ...
 # $ ID         : int  3 4 5 6 7 8 9 10 11 12 ...
 # $ GRIDCODE   : int  4560 4559 7730 3900 4560 6595 4947 8391 8392 3293 ...
 # $ patchID    : int  4560 4559 7730 3900 4560 6595 4947 8391 8392 3293 ...
 # $ estYr      : int  2000 2000 2007 1997 2000 2005 2001 2008 2008 1993 ...
 # $ min_dist_km: num  0 1.79 2.14 4.4 0 ...
 # $ d_patchID  : Factor w/ 2513 levels "1","10000","10015",..: 1153 1153 1788 967 1153 1341 967 1474 2164 852 ...
 # $ area_ha    : num  175 71.3 149 71.3 175 ...
 # $ pat_ct500  : int  1 1 1 1 1 1 2 1 1 0 ...
 # $ pat_ct1000 : int  1 1 1 1 1 2 2 4 1 2 ...
 # $ inv_area   : num  0.00572 0.01403 0.00671 0.01403 0.00572 ...
 # $ wpat_ct500 : num  0.00572 0.01403 0.00671 0.01403 0.00572 ...
 # $ wpat_ct1000: num  0.00572 0.01403 0.00671 0.01403 0.00572 ...

# str(join_unk) # OLD:
# 'data.frame':	5229 obs. of  14 variables:
 # $ FID       : int  1 2 3 4 5 6 7 8 9 10 ...
 # $ ID        : int  2 3 4 5 6 7 8 9 10 11 ...
 # $ GRIDCODE  : int  3135 3964 8449 4614 6640 8449 4991 8448 7789 7793 ...
 # $ patchID   : int  3135 3964 8449 4614 6640 8449 4991 8448 7789 7793 ...
 # $ estYr     : int  1991 1997 2008 2000 2005 2008 2001 2008 2007 2007 ...
 # $ er_maj    : int  9 9 9 9 9 9 9 9 9 9 ...
 # $ min_dist_k: num  NA 4.14 0 0 1.13 ...
 # $ d_patchID : Factor w/ 2529 levels "1","1003","10040",..: NA 975 1475 1172 975 1475 975 2166 1788 2290 ...
 # $ area_ha   : num  48.6 68 71.3 165.2 77.8 ...
 # $ pat_ct500 : int  0 1 3 1 0 3 3 1 1 4 ...
 # $ pat_ct1000: int  1 2 5 2 1 5 4 2 3 5 ...
 # $ inv_area  : num  0.02058 0.0147 0.01403 0.00605 0.01286 ...
 # $ wpat_ct500: num  0 0.0147 0.04209 0.00605 0 ...
 # $ wpat_ct100: num  0.0206 0.0294 0.0701 0.0121 0.0129 ...

 plot(join_unk$area_ha,join_unk$pat_ct1000)

> cor.test(join_unk$area_ha,join_unk$pat_ct1000)

	# Pearson's product-moment correlation NEW:

# data:  join_unk$area_ha and join_unk$pat_ct1000
# t = 79.356, df = 5266, p-value < 2.2e-16
# alternative hypothesis: true correlation is not equal to 0
# 95 percent confidence interval:
 # 0.7254178 0.7500240
# sample estimates:
      # cor 
# 0.7379661 

# Strong correlation between area and pat_ct1000
# Argument for using inverse area as value for self-potential field.


	# # Pearson's product-moment correlation OLD

# data:  join_unk$area_ha and join_unk$pat_ct1000
# t = 79.418, df = 5227, p-value < 2.2e-16
# alternative hypothesis: true correlation is not equal to 0
# 95 percent confidence interval:
 # 0.7269433 0.7515201
# sample estimates:
     # cor 
# 0.739478 

# Strong correlation between area and pat_ct1000
# Argument for using inverse area as value for self-potential field.

### NOW FOLLOW GETIS ORD PARAMETER PREP























